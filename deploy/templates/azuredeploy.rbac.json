{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "principalId": {
            "type": "string",
            "metadata": {
                "description": "The principal to assign roles to."
            }
        },
        "assignRoles": {
            "type": "array",
            "metadata": {
                "description": "Roles to assign."
            }
        },
        "scope": {
            "type": "string",
            "defaultValue": "[resourceGroup().id]",
            "metadata": {
                "description": "Scope of the assingment.  Defaults to resource group."
            }
        },
        "tags": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Tags for Azure resources."
            }
        }
    },
    "variables": {
        "roleNames": {
            "Contributor": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
            "KeyVaultSecretOfficer": "[resourceId('Microsoft.Authorization/roleDefinitions', 'b86a8fe4-44ce-4948-aee5-eccb2c155cd7')]",
            "NetworkContributor": "[resourceId('Microsoft.Authorization/roleAssignments', '4d97b98b-1d4f-4787-a291-c67834d212e7')]",
            "VirtualMachineContributor": "[resourceId('Microsoft.Authorization/roleAssignments', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]",
            "ManagedIdentityOperator": "[resourceId('Microsoft.Authorization/roleAssignments', 'f1a07417-d97a-45cb-824c-7a7467783830')]",
            "AzureKubernetesServiceClusterAdmin": "[resourceId('Microsoft.Authorization/roleAssignments', '0ab0b1a8-8aac-4efd-b8c2-3ee1fb270be8')]",
            "AzureKubernetesServiceClusterUser": "[resourceId('Microsoft.Authorization/roleAssignments', '4abbcc35-e782-43d8-92c5-2d3f1bd2253f')]",
            "StorageAccountContributor": "[resourceId('Microsoft.Authorization/roleAssignments', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
            "StorageBlobDataContributor": "[resourceId('Microsoft.Authorization/roleAssignments', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
            "StorageBlobDataOwner": "[resourceId('Microsoft.Authorization/roleAssignments', 'b7e6dc6d-f1e8-4753-8033-0f276bb0955b')]",
            "StorageBlobDataReader": "[resourceId('Microsoft.Authorization/roleAssignments', '2a2b9908-6ea1-4ae2-8e65-a410df84e7d1')]"
        }
    },
    "resources": [
        {
            "comments": "Assign principal the role over a resource that is not in the current resource group.",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-08-01",
            "condition": "[not(startsWith(toLower(parameters('scope')), toLower(resourceGroup().id)))]",
            "name": "[concat('rbac.', take(uniqueString(parameters('principalId'), parameters('scope')), 5))]",
            "copy": {
                "count": "[length(parameters('assignRoles'))]",
                "mode": "Serial",
                "name": "roleAssignmentCopy"
            },
            "resourceGroup": "[parameters('scope')]",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "roleDefinitionId": {
                        "value": "[variables('roleNames')[string(parameters('assignRoles')[copyIndex()])]]"
                    },
                    "roleAssignmentId": {
                        "value": "[guid(parameters('principalId'), parameters('scope'), string(parameters('assignRoles')[copyIndex()]))]"
                    },
                    "principalId": {
                        "value": "[parameters('principalId')]"
                    },
                    "scope": {
                        "value": "[parameters('scope')]"
                    },
                    "tags": {
                        "value": "[parameters('tags')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "roleAssignmentId": {
                            "type": "string"
                        },
                        "roleDefinitionId": {
                            "type": "string"
                        },
                        "principalId": {
                            "type": "string"
                        },
                        "scope": {
                            "type": "string"
                        },
                        "tags": {
                            "type": "object"
                        }
                    },
                    "resources": [
                        {
                            "comments": "Every role can only be assigned to a principal once and assignments are idempotent.",
                            "type": "Microsoft.Authorization/roleAssignments",
                            "name": "[parameters('roleAssignmentId')]",
                            "apiVersion": "2020-04-01-preview",
                            "location": "[resourceGroup().location]",
                            "tags": "[parameters('tags')]",
                            "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "scope": "[parameters('scope')]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ]
                }
            }
        },
        {
            "comments": "Assign specified roles to principal over current resource group.",
            "type": "Microsoft.Authorization/roleAssignments",
            "condition": "[startsWith(toLower(parameters('scope')), toLower(resourceGroup().id))]",
            "copy": {
                "count": "[length(parameters('assignRoles'))]",
                "mode": "Serial",
                "name": "roleAssignmentCopy"
            },
            "name": "[guid(parameters('principalId'), parameters('scope'), string(parameters('assignRoles')[copyIndex()]))]",
            "apiVersion": "2020-04-01-preview",
            "location": "[resourceGroup().location]",
            "tags": "[parameters('tags')]",
            "properties": {
                "roleDefinitionId": "[variables('roleNames')[string(parameters('assignRoles')[copyIndex()])]]",
                "principalId": "[parameters('principalId')]",
                "scope": "[parameters('scope')]",
                "principalType": "ServicePrincipal"
            }
        }
    ]
}